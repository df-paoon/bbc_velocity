<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BBC World Service ‚Äî Speed Top / Player Bottom</title>

  <style>
    :root{
      color-scheme: light dark;
      --bg-light:#f6f7f9; --bg-dark:#0f1115;
      --fg-light:#111;    --fg-dark:#f5f5f5;
      --card-light:#fff;  --card-dark:#171a21;
      --border-light:#dcdfe6; --border-dark:#2a2f3a;
      --accent:#0077cc;
      --ok:#16a34a;
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",Arial,sans-serif;
      background:var(--bg-light); color:var(--fg-light);
      transition:background .3s,color .3s;
      padding: 16px 16px 150px 16px; /* bottom player space */
    }
    body.dark{ background:var(--bg-dark); color:var(--fg-dark); }
    .shell{ max-width:900px; margin:0 auto; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:14px;
    }
    .theme-toggle{
      font-size:1.2rem;
      padding:.5rem .75rem;
      border-radius:12px;
      border:1px solid rgba(127,127,127,.35);
      background:transparent;
      color:inherit;
      cursor:pointer;
    }
    .theme-toggle:hover{ background: rgba(127,127,127,.08); }
    #simToggle.on{
      border-color: rgba(22,163,74,.75);
      box-shadow: 0 0 0 2px rgba(22,163,74,.25) inset;
    }

    /* Card */
    .speedHero{
      text-align:center;
      border-radius:18px;
      border:1px solid var(--border-light);
      background:var(--card-light);
      padding:18px 14px;
      transition:background .3s, border .3s;
    }
    body.dark .speedHero{
      background:var(--card-dark);
      border:1px solid var(--border-dark);
    }
    .speedLabel{
      font-size:14px;
      letter-spacing:.16em;
      text-transform:uppercase;
      opacity:.75;
      margin-bottom:6px;
    }

    /* ===== Centered number + unit (unit never overlaps) ===== */
    .speedRow{
      display: grid;
      grid-template-columns: 1fr auto 1fr; /* left spacer / number / unit */
      align-items: baseline;
      column-gap: 12px;

      direction: ltr;
      unicode-bidi: isolate;
    }
    .speedUnitGhost{
      justify-self: end;
      visibility: hidden;   /* takes space, not visible */
      white-space: nowrap;
      font-size: 24px;
      padding: 0 .25em;
    }

    /* Speed big number */
    #speedVal{
      justify-self: center;

      font-size:96px;
      font-weight:900;
      line-height:1;
      letter-spacing:0.5px;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;

      color: var(--spd-color, currentColor);
      text-shadow: 0 0 18px var(--spd-glow, transparent);
      transition: color .25s linear, text-shadow .25s linear;
    }

    /* Course big number */
    #headVal{
      justify-self: center;

      font-size:72px;
      font-weight:900;
      line-height:1;
      letter-spacing:0.2px;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }
    #headArrow{
      display:inline-block;
      transform-origin: 50% 60%;
      margin-right:6px;
    }

    .speedUnit{
      justify-self: start;

      font-size:24px;
      opacity:.85;
      white-space:nowrap;

      background: rgba(0,0,0,.08);
      padding: 0 .25em;
      border-radius: .4em;
    }
    body.dark .speedUnit{
      background: rgba(255,255,255,.10);
    }

    .gpsMeta{
      margin-top:8px;
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-size:13px;
      opacity:.75;
    }

    /* ===== Location line (bigger) ===== */
    .locRow{
      margin-top:10px;
      display:flex;
      align-items:baseline;
      justify-content:center;
      flex-wrap:wrap;
      gap:10px;
    }
    #locName{
      font-size:30px;      /* ~2x-ish */
      font-weight:900;
      line-height:1.08;
      letter-spacing:0.2px;
    }
    #locDir{
      font-size:22px;
      font-weight:800;
      opacity:.92;
      white-space:nowrap;

      background: rgba(0,0,0,.08);
      padding: 0 .35em;
      border-radius: .45em;
    }
    body.dark #locDir{
      background: rgba(255,255,255,.10);
    }
    .locDetail{
      margin-top:8px;
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-size:14px;
      opacity:.78;
    }

    .statusCard{
      margin-top:12px;
      border-radius:14px;
      border:1px solid var(--border-light);
      background:var(--card-light);
      padding:12px 14px;
      transition:background .3s, border .3s;
    }
    body.dark .statusCard{
      background:var(--card-dark);
      border:1px solid var(--border-dark);
    }
    .mono{ font-family: ui-monospace, Menlo, Consolas, monospace; }
    .ok{ color: var(--ok); font-weight:700; }
    .hint{ margin-top:8px; font-size:.92rem; opacity:.8; }

    /* Bottom fixed player bar */
    .playerBar{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:10px 12px 14px 12px;
      border-top:1px solid var(--border-light);
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      transition: background .3s, border .3s;
      z-index:900;
    }
    body.dark .playerBar{
      border-top:1px solid var(--border-dark);
      background:rgba(23,26,33,.92);
    }
    .playerInner{ max-width:900px; margin:0 auto; }
    audio{ width:100%; height:40px; }
    .playerTopRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .playerTitle{ font-weight:700; opacity:.9; }
    .miniBtn{
      font-size:1rem;
      padding:.45rem .7rem;
      border-radius:12px;
      border:1px solid rgba(127,127,127,.35);
      background:transparent;
      color:inherit;
      cursor:pointer;
      white-space:nowrap;
    }
    .miniBtn:hover{ background: rgba(127,127,127,.08); }

    /* Floating play/reload buttons */
    #reloadBtn, #floatPlayBtn{
      position:fixed;
      right:16px;
      width:66px;height:66px;
      border-radius:50%;
      border:none;
      color:#fff;
      box-shadow:0 2px 10px rgba(0,0,0,.35);
      cursor:pointer;
      z-index:1000;
      font-size:2rem;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:transform .2s, background .3s;
      user-select:none;
    }
    #reloadBtn{ bottom:20px; background:var(--accent); }
    #reloadBtn:hover{ transform:scale(1.08); }
    body.dark #reloadBtn{ background:#3399ff; }

    #floatPlayBtn{
      bottom:100px;
      background:#28a745;
      display:none;
    }
    #floatPlayBtn:hover{ transform:scale(1.08); }
    body.dark #floatPlayBtn{ background:#34c759; }
  </style>
</head>

<body>
  <div class="shell">
    <div class="topbar">
      <div class="mono" style="opacity:.75;">BBC World Service + Speed</div>
      <div style="display:flex; gap:10px;">
        <button class="theme-toggle" id="simToggle" title="Toggle speed simulation">SIM</button>
        <button class="theme-toggle" id="themeToggle" title="Toggle dark/light">üåô</button>
      </div>
    </div>

    <!-- Speed -->
    <div class="speedHero">
      <div class="speedLabel">Speed</div>
      <div class="speedRow" aria-label="Speed">
        <span class="speedUnitGhost" aria-hidden="true">km/h</span>
        <span id="speedVal">--</span>
        <span class="speedUnit">km/h</span>
      </div>
      <div class="gpsMeta"><span id="gpsStatus">GPS: idle</span></div>
    </div>

    <!-- GPS Course (from GPS heading/bearing) -->
    <div class="speedHero" style="margin-top:12px;">
      <div class="speedLabel">GPS Course</div>

      <!-- NEW: location + direction -->
      <div class="locRow" aria-label="Location and direction">
        <span id="locName">--</span>
        <span id="locComma" aria-hidden="true">,</span>
        <span id="locDir">--</span>
      </div>
      <div class="locDetail"><span id="locDetail">--</span></div>

      <div class="speedRow" aria-label="GPS course" style="margin-top:10px;">
        <span class="speedUnitGhost" aria-hidden="true">¬∞</span>
        <span id="headVal">--</span>
        <span class="speedUnit">¬∞</span>
      </div>
      <div class="gpsMeta">
        <span id="headStatus">COURSE: idle</span>
        <span style="margin-left:10px;">
          <span id="headArrow" aria-hidden="true" style="display:inline-block;">‚ñ≤</span>
          <span id="headCard">--</span>
        </span>
      </div>
    </div>

    <div class="statusCard">
      <div class="mono"><span id="status">Loading‚Ä¶</span></div>
      <div class="hint">
        ÈÅãËª¢‰∏≠„ÅÆÊ≥®Ë¶ñ„ÉªÊìç‰Ωú„ÅØÂç±Èô∫„Å™„ÅÆ„Åß„ÄÅË®≠ÂÆö„ÅØÂÅúËªä‰∏≠„Å´„ÄÇ
      </div>
    </div>
  </div>

  <div class="playerBar">
    <div class="playerInner">
      <div class="playerTopRow">
        <div class="playerTitle">BBC World Service (Live)</div>
        <button id="playBtn" class="miniBtn" hidden>‚ñ∂Ô∏é Play</button>
      </div>
      <audio id="player" preload="metadata" autoplay playsinline controls></audio>
      <div class="hint" style="margin-top:6px;">
        Âè≥‰∏ãÔºö‚ñ∂Ô∏éÔºàÂÜçÁîüÔºâÔºèüîÑÔºàÂÜçË™≠„ÅøËæº„ÅøÔºâ„ÄÇFirefox „ÅØ üîí‚Üí Ëá™ÂãïÂÜçÁîü„Çí„ÄåË®±ÂèØ„Äç„Å´„ÄÇ
      </div>
      <div id="err" class="mono" style="margin-top:6px; color:#e05; font-weight:700;"></div>
    </div>
  </div>

  <button id="floatPlayBtn" title="Play">‚ñ∂Ô∏é</button>
  <button id="reloadBtn" title="Reload">üîÑ</button>

  <!-- ‚òÖ CDN„Åß„ÅØ„Å™„Åè„ÄÅassets„Å´ÂêåÊ¢±„Åó„Åü hls.min.js „ÇíË™≠„ÇÄ -->
  <script src="hls.min.js"></script>

  <script>
   /* ---- theme ---- */
   const body = document.body;
   const prefersDark = window.matchMedia("(prefers-color-scheme: dark)");
   const themeToggle = document.getElementById("themeToggle");
   function setTheme(dark){
       if(dark){ body.classList.add("dark"); themeToggle.textContent="üåû"; }
       else { body.classList.remove("dark"); themeToggle.textContent="üåô"; }
   }
   setTheme(prefersDark.matches);
   prefersDark.addEventListener("change", e => setTheme(e.matches));
   themeToggle.onclick = () => setTheme(!body.classList.contains("dark"));

   /* ---- GPS speed (fast follow) + color + simulation + course + location ---- */
   (function(){
       const speedEl   = document.getElementById("speedVal");
       const gpsStatus = document.getElementById("gpsStatus");
       const simBtn    = document.getElementById("simToggle");

       const headValEl    = document.getElementById("headVal");
       const headStatusEl = document.getElementById("headStatus");
       const headArrowEl  = document.getElementById("headArrow");
       const headCardEl   = document.getElementById("headCard");

       const locNameEl   = document.getElementById("locName");
       const locDirEl    = document.getElementById("locDir");
       const locDetailEl = document.getElementById("locDetail");
       const locCommaEl  = document.getElementById("locComma");

       let watchId = null;
       let last = null; // {lat, lon, t}

       // ===== follower (time-constant) =====
       let targetKmh = null;       // ÊúÄÊñ∞„ÅÆÁõÆÊ®ôÂÄ§ÔºàGPS/Êé®ÂÆö/SIM„ÅåÂÖ•„Çå„ÇãÔºâ
       let displayKmh = null;      // Ë°®Á§∫Áî®
       let lastUiUpdate = 0;
       let rafId = null;

       let lastTickTs = null;
       let lastSampleTs = null;

       // ‚òÖ ËøΩÂæì„ÅÆÈÄü„ÅïÔºàÁßíÔºâ
       const TAU_DISPLAY = 0.10;

       // ÂÖ•ÂäõÂÅ¥„ÅÆÂæÆÂ∞èÂπ≥ÊªëÂåñ
       const TAU_INPUT = 0.05;

       // ===== SIM =====
       let simOn = false;
       let simTimer = null;
       let simT = 0;
       let simHeading = 0;

       // ===== reverse geocoding (Nominatim) =====
       const NOMINATIM_REVERSE = "https://nominatim.openstreetmap.org/reverse";
       const REVERSE_ZOOM = 17;           // streets level
       const REV_MIN_MOVE_M = 300;        // update only after moving
       const REV_MIN_INTERVAL_MS = 15000; // throttle
       const REV_MAX_STALE_MS = 180000;   // refresh even if not moved much

       let revLast = null;         // {lat, lon, ts}
       let revInFlight = false;
       const placeCache = new Map(); // key -> {primary, detail}

       function setGpsStatus(msg){ gpsStatus.textContent = "GPS: " + msg; }
       function setHeadStatus(msg){ headStatusEl.textContent = "COURSE: " + msg; }

       function clamp(x,a,b){ return Math.min(b, Math.max(a,x)); }

       function formatKmh(v){
           if(v == null || !isFinite(v)) return "--";
           if(v < 10) return v.toFixed(1);
           return v.toFixed(0);
       }

       function wrap360(d){
         d = d % 360;
         if(d < 0) d += 360;
         return d;
       }

       function formatDeg(d){
         if(d == null || !isFinite(d)) return "--";
         return String(Math.round(wrap360(d)));
       }

       function compass16(deg){
         if(deg == null || !isFinite(deg)) return "--";
         const dirs = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
         const i = Math.round(wrap360(deg) / 22.5) % 16;
         return dirs[i];
       }

       function bearingDeg(a, b){
         const toRad = (x) => x * Math.PI / 180;
         const toDeg = (x) => x * 180 / Math.PI;
         const lat1 = toRad(a.lat), lat2 = toRad(b.lat);
         const dLon = toRad(b.lon - a.lon);
         const y = Math.sin(dLon) * Math.cos(lat2);
         const x = Math.cos(lat1)*Math.sin(lat2) - Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);
         return wrap360(toDeg(Math.atan2(y, x)));
       }

       function setLocation(primary, detail){
         const p = (primary && String(primary).trim()) ? String(primary).trim() : "--";
         const d = (detail && String(detail).trim()) ? String(detail).trim() : "--";
         locNameEl.textContent = p;
         locDetailEl.textContent = d;
         locCommaEl.style.display = (p === "--") ? "none" : "inline";
       }

       function setCourse(deg){
         if(deg == null || !isFinite(deg)){
           headValEl.textContent = "--";
           headCardEl.textContent = "--";
           headArrowEl.style.transform = "rotate(0deg)";
           locDirEl.textContent = "--";
           return;
         }
         const d = wrap360(deg);
         headValEl.textContent = formatDeg(d);
         headCardEl.textContent = compass16(d);
         headArrowEl.style.transform = `rotate(${d}deg)`;
         locDirEl.textContent = compass16(d);
       }

       function updateSpeedColor(vKmh){
           if(vKmh == null || !isFinite(vKmh)){
               document.body.style.removeProperty("--spd-color");
               document.body.style.removeProperty("--spd-glow");
               return;
           }
           const v = clamp(vKmh, 0, 120);
           const t = v / 120;
           const hue = 120 * (1 - t);
           const sat = 92;
           const isDark = document.body.classList.contains("dark");
           const light = isDark ? 62 : 42;

           const color = "hsl(" + hue + " " + sat + "% " + light + "%)";
           const glowAlpha = isDark ? (0.20 + 0.25*t) : (0.10 + 0.18*t);
           const glow = "hsla(" + hue + " " + sat + "% " + light + "% / " + glowAlpha + ")";

           document.body.style.setProperty("--spd-color", color);
           document.body.style.setProperty("--spd-glow", glow);
       }

       function expFollow(current, target, dt, tau){
           if(current == null) return target;
           if(tau <= 0) return target;
           const k = 1 - Math.exp(-dt / tau);
           return current + (target - current) * k;
       }

       function pushTargetSpeed(sampleKmh){
           const now = performance.now();
           const dt = (lastSampleTs == null) ? 0 : (now - lastSampleTs) / 1000;
           lastSampleTs = now;

           if(targetKmh == null) targetKmh = sampleKmh;
           else targetKmh = expFollow(targetKmh, sampleKmh, Math.max(0, dt), TAU_INPUT);
       }

       function tick(ts){
           if(targetKmh == null){
               rafId = requestAnimationFrame(tick);
               return;
           }
           if(lastTickTs == null) lastTickTs = ts;
           const dt = Math.min(0.25, Math.max(0, (ts - lastTickTs) / 1000));
           lastTickTs = ts;

           displayKmh = expFollow(displayKmh, targetKmh, dt, TAU_DISPLAY);

           // UIÊõ¥Êñ∞Ôºà50ms„Åî„Å®Ôºâ
           if(ts - lastUiUpdate > 50){
               const shown = Math.max(0, displayKmh);
               speedEl.textContent = formatKmh(shown);
               updateSpeedColor(shown);
               lastUiUpdate = ts;
           }
           rafId = requestAnimationFrame(tick);
       }

       function startLoop(){
           if(rafId == null) rafId = requestAnimationFrame(tick);
       }

       function toRad(x){ return x * Math.PI / 180; }
       function haversineMeters(a, b){
           const R = 6371000;
           const dLat = toRad(b.lat - a.lat);
           const dLon = toRad(b.lon - a.lon);
           const lat1 = toRad(a.lat), lat2 = toRad(b.lat);
           const s = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
           return 2 * R * Math.asin(Math.sqrt(s));
       }

       function pick(){
         for(let i=0;i<arguments.length;i++){
           const v = arguments[i];
           if(v != null && String(v).trim() !== "") return String(v);
         }
         return null;
       }

       function cacheKey(lat, lon){
         // ~100m grid
         const r = (x) => Math.round(x * 1000) / 1000;
         return r(lat) + "," + r(lon);
       }

       function parseNominatim(js){
         const a = (js && js.address) ? js.address : {};
         const pref  = pick(a.state, a.region);
         const city  = pick(a.city, a.town, a.village, a.municipality, a.county);
         const ward  = pick(a.city_district, a.suburb, a.borough, a.district);
         const neigh = pick(a.neighbourhood, a.quarter, a.hamlet);
         const road  = pick(a.road, a.pedestrian, a.cycleway, a.footway, a.path, a.highway);
         const house = pick(a.house_number);

         // Big line: city + (ward/neigh)
         let primary = [city, ward, neigh].filter(Boolean).join(" ");
         if(!primary) primary = pick(js.name, js.display_name);
         if(primary && primary.indexOf(",") >= 0) primary = primary.split(",")[0].trim();
         if(!primary) primary = "--";

         // Detail: road + house / prefecture
         let detailParts = [];
         if(road) detailParts.push(road + (house ? (" " + house) : ""));
         if(pref) detailParts.push(pref);

         if(!detailParts.length && js && js.display_name){
           const parts = String(js.display_name).split(",").map(s => s.trim()).filter(Boolean);
           detailParts = parts.slice(0, 3);
         }

         const detail = detailParts.length ? detailParts.join(" / ") : "--";
         return { primary, detail };
       }

       async function reverseGeocode(lat, lon){
         const key = cacheKey(lat, lon);
         const cached = placeCache.get(key);
         if(cached) return cached;

         const url =
           NOMINATIM_REVERSE +
           `?format=jsonv2&lat=${encodeURIComponent(lat)}` +
           `&lon=${encodeURIComponent(lon)}` +
           `&zoom=${REVERSE_ZOOM}&addressdetails=1&accept-language=ja`;

         const resp = await fetch(url, { headers: { "Accept": "application/json" } });
         if(!resp.ok) throw new Error("HTTP " + resp.status);

         const js = await resp.json();
         const parsed = parseNominatim(js);

         placeCache.set(key, parsed);
         if(placeCache.size > 80){
           const first = placeCache.keys().next().value;
           placeCache.delete(first);
         }
         return parsed;
       }

       function shouldReverse(nowLatLon){
         const nowTs = performance.now();
         if(revInFlight) return false;
         if(!revLast) return true;

         const dt = nowTs - revLast.ts;
         const moved = haversineMeters({lat: revLast.lat, lon: revLast.lon}, nowLatLon);

         if(dt >= REV_MAX_STALE_MS) return true;
         if(moved >= REV_MIN_MOVE_M && dt >= REV_MIN_INTERVAL_MS) return true;
         return false;
       }

       function maybeUpdatePlace(nowLatLon){
         if(!shouldReverse(nowLatLon)) return;

         revInFlight = true;
         const nowTs = performance.now();

         reverseGeocode(nowLatLon.lat, nowLatLon.lon)
           .then(({primary, detail}) => {
             setLocation(primary, detail);
             revLast = { lat: nowLatLon.lat, lon: nowLatLon.lon, ts: nowTs };
           })
           .catch(() => {
             // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ/CORS/Ê∑∑Èõë„Å™„Å©„ÅßÂ§±Êïó„Åó„ÅÜ„Çã
             if(locDetailEl.textContent === "--") locDetailEl.textContent = "loc unavailable";
           })
           .finally(() => { revInFlight = false; });
       }

       function startGps(){
           if(!("geolocation" in navigator)){
               setGpsStatus("not supported ‚Üí SIM");
               setHeadStatus("not supported ‚Üí SIM");
               setLocation("SIM", "--");
               enableSim(true);
               return;
           }
           if(watchId !== null) return;

           setGpsStatus("requesting‚Ä¶");
           setHeadStatus("requesting‚Ä¶");
           setLocation("loc‚Ä¶", "--");
           startLoop();

           watchId = navigator.geolocation.watchPosition(
               (pos) => {
                   const c = pos.coords;
                   const t = pos.timestamp;
                   const now = { lat: c.latitude, lon: c.longitude, t };
                   const prev = last;

                   let speed_mps = null;
                   let dist = null;
                   let dt = null;

                   if(typeof c.speed === "number" && isFinite(c.speed)){
                       speed_mps = c.speed;
                   } else if(prev) {
                       dt = (now.t - prev.t) / 1000;
                       if(dt > 0.15){
                           dist = haversineMeters(prev, now);
                           speed_mps = dist / dt;
                       }
                   }

                   // --- course / heading ---
                   let courseDeg = null;

                   if(typeof c.heading === "number" && isFinite(c.heading)){
                     courseDeg = c.heading;
                   } else if(prev) {
                     if(dt == null) dt = (now.t - prev.t) / 1000;
                     if(dist == null && dt > 0.15) dist = haversineMeters(prev, now);

                     if(dt > 0.15 && dist != null && dist > 3){
                       courseDeg = bearingDeg(prev, now);
                     }
                   }

                   const sp = (speed_mps != null && isFinite(speed_mps)) ? speed_mps : null;
                   if(sp != null && sp < 1.5){
                     setCourse(null);
                     setHeadStatus("low speed");
                   } else if(courseDeg != null){
                     setCourse(courseDeg);
                     setHeadStatus("ok ‚úì");
                   } else {
                     setCourse(null);
                     setHeadStatus("waiting‚Ä¶");
                   }

                   last = now;

                   if(speed_mps != null){
                       pushTargetSpeed(Math.max(0, speed_mps * 3.6));
                   }

                   // NEW: reverse geocode (throttled)
                   maybeUpdatePlace({ lat: now.lat, lon: now.lon });

                   setGpsStatus("fix ‚úì");
               },
               (err) => {
                   speedEl.textContent = "--";
                   updateSpeedColor(null);

                   setCourse(null);

                   if(err && err.code === 1){
                       setGpsStatus("denied ‚Üí SIM");
                       setHeadStatus("denied ‚Üí SIM");
                   } else if(err && err.code === 2){
                       setGpsStatus("unavailable ‚Üí SIM");
                       setHeadStatus("unavailable ‚Üí SIM");
                   } else if(err && err.code === 3){
                       setGpsStatus("timeout ‚Üí SIM");
                       setHeadStatus("timeout ‚Üí SIM");
                   } else {
                       setGpsStatus("error ‚Üí SIM");
                       setHeadStatus("error ‚Üí SIM");
                   }

                   setLocation("SIM", "--");
                   enableSim(true);
               },
               { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
           );
       }

       function stopGps(){
           try{ if(watchId !== null){ navigator.geolocation.clearWatch(watchId); watchId = null; } }catch{}
           last = null;
           revLast = null;
           revInFlight = false;
       }

       function startSim(){
           if(simTimer) return;
           startLoop();
           setGpsStatus("SIM on");
           setHeadStatus("SIM on");
           setLocation("SIM", "--");

           simTimer = setInterval(() => {
               simT += 0.15;
               const base = 55 + 35*Math.sin(simT*0.45) + 18*Math.sin(simT*1.2);
               const stopPulse = (Math.sin(simT*0.12) > 0.92) ? 0.18 : 1.0;
               let v = clamp(base * stopPulse, 0, 115);
               v = clamp(v + (Math.random()*2.2 - 1.1), 0, 115);
               pushTargetSpeed(v);

               simHeading = wrap360(simHeading + (Math.random()*18 - 9));
               setCourse(simHeading);
           }, 250);
       }

       function stopSim(){
           if(simTimer){
               clearInterval(simTimer);
               simTimer = null;
           }
       }

       function enableSim(on){
           simOn = !!on;
           if(simBtn){
               simBtn.classList.toggle("on", simOn);
               simBtn.textContent = simOn ? "SIM‚úì" : "SIM";
           }
           if(simOn){
               stopGps();
               startSim();
           }else{
               stopSim();
               startGps();
           }
       }

       if(simBtn){
           simBtn.addEventListener("click", () => enableSim(!simOn));
       }

       enableSim(false); // try GPS first

       function cleanup(){
           stopSim();
           stopGps();
           try{ if(rafId != null){ cancelAnimationFrame(rafId); rafId = null; } }catch{}
       }
       window.addEventListener("pagehide", cleanup);
       window.addEventListener("beforeunload", cleanup);
   })();

   /* ---- audio ---- */
   (function(){
       const HLS_URL = "https://as-hls-ww.live.cf.md.bbci.co.uk/pool_87948813/live/ww/bbc_world_service/bbc_world_service.isml/bbc_world_service-audio=96000.norewind.m3u8";
       const MP3_URL = "https://stream.live.vc.bbcmedia.co.uk/bbc_world_service";

       const audio        = document.getElementById("player");
       const statusEl     = document.getElementById("status");
       const playBtn      = document.getElementById("playBtn");
       const floatPlayBtn = document.getElementById("floatPlayBtn");
       const reloadBtn    = document.getElementById("reloadBtn");
       const errEl        = document.getElementById("err");

       const ua = navigator.userAgent || "";
       const isAndroid = /Android/i.test(ua);
       let hls = null;

       function setStatus(msg, ok=false){
           statusEl.textContent = msg;
           statusEl.className = ok ? "ok mono" : "mono";
       }

       async function tryPlay(){
           try{
               await audio.play();
               setStatus("Playing ‚úì", true);
               playBtn.hidden = true;
               floatPlayBtn.style.display = "none";
           }catch(e){
               setStatus("Autoplay blocked ‚Äî press ‚ñ∂Ô∏é");
               playBtn.hidden = false;
               floatPlayBtn.style.display = "flex";
           }
       }

       function useMp3(){
           audio.src = MP3_URL;
           audio.load();
           tryPlay();
       }

       function cleanupHlsOnly(){
           try{ if(hls){ hls.destroy(); hls = null; } }catch{}
       }

       function useHls(){
           if(audio.canPlayType("application/vnd.apple.mpegurl")){
               audio.src = HLS_URL;
               audio.addEventListener("loadedmetadata", tryPlay, { once:true });
               audio.addEventListener("error", () => {
                   errEl.textContent = "HLS error ‚Äî switching to MP3.";
                   useMp3();
               }, { once:true });
               return;
           }
           if(window.Hls && window.Hls.isSupported()){
               hls = new Hls({
                   autoStartLoad:true,
                   maxBufferLength:10,
                   backBufferLength:10,
                   liveSyncDurationCount:3,
                   liveMaxLatencyDurationCount:10
               });
               hls.attachMedia(audio);
               hls.on(Hls.Events.MEDIA_ATTACHED, () => hls.loadSource(HLS_URL));
               hls.on(Hls.Events.MANIFEST_PARSED, () => tryPlay());
               hls.on(Hls.Events.ERROR, (ev, data) => {
                   if(data && data.fatal){
                       errEl.textContent = "HLS fatal error ‚Äî switching to MP3.";
                       cleanupHlsOnly();
                       useMp3();
                   }
               });
           } else {
               useMp3();
           }
       }

       function cleanupAll(){
           try{ audio.pause(); }catch{}
           try{ audio.removeAttribute("src"); audio.load(); }catch{}
           cleanupHlsOnly();
       }

       function start(){
           setStatus("Loading‚Ä¶");
           if(isAndroid) useMp3(); else useHls();
       }

       playBtn.addEventListener("click", tryPlay);
       floatPlayBtn.addEventListener("click", tryPlay);

       reloadBtn.addEventListener("click", () => {
           cleanupAll();
           setTimeout(() => location.reload(), 0);
       });

       window.addEventListener("beforeunload", cleanupAll);
       window.addEventListener("pagehide", cleanupAll);

       start();
   })();
  </script>
</body>
</html>
